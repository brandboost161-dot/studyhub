generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// SCHOOL MODEL
// Represents a university/college
// ============================================
model School {
  id        String   @id @default(cuid())
  name      String
  domain    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  users       User[]
  departments Department[]
  courses     Course[]
  
  @@index([domain])
}

// ============================================
// USER MODEL
// Represents a student account
// ============================================
model User {
  id                String   @id @default(cuid())
  name              String
  email             String   @unique
  passwordHash      String
  schoolId          String
  reputationScore   Int      @default(0)
  emailVerified     Boolean  @default(false)
  verificationToken String?  @unique
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  school          School           @relation(fields: [schoolId], references: [id])
  reviews         CourseReview[]
  studyResources  StudyResource[]
  helpfulVotes    HelpfulVote[]
  resourceUpvotes ResourceUpvote[]
  savedCourses    SavedCourse[]
  savedResources  SavedResource[]
  
  @@index([schoolId])
  @@index([email])
}

// ============================================
// DEPARTMENT MODEL
// Academic departments (e.g., "Computer Science")
// ============================================
model Department {
  id        String   @id @default(cuid())
  schoolId  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  school  School   @relation(fields: [schoolId], references: [id])
  courses Course[]
  
  @@unique([schoolId, name])
  @@index([schoolId])
}

// ============================================
// COURSE MODEL
// Individual courses (e.g., "ECON 101")
// ============================================
model Course {
  id           String   @id @default(cuid())
  schoolId     String
  departmentId String
  courseCode   String
  title        String
  description  String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  school         School          @relation(fields: [schoolId], references: [id])
  department     Department      @relation(fields: [departmentId], references: [id])
  reviews        CourseReview[]
  studyResources StudyResource[]
  savedBy        SavedCourse[]
  
  @@unique([schoolId, courseCode])
  @@index([schoolId])
  @@index([departmentId])
}

// ============================================
// COURSE REVIEW MODEL
// Student reviews of courses
// ============================================
model CourseReview {
  id                 String   @id @default(cuid())
  userId             String
  courseId           String
  workloadRating     Int
  difficultyRating   Int
  examStyle          String?  @db.Text
  attendanceRequired Boolean  @default(false)
  overallRating      Int
  reviewText         String   @db.Text
  helpfulVotes       Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  user           User          @relation(fields: [userId], references: [id])
  course         Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  helpfulVotedBy HelpfulVote[]
  
  @@unique([userId, courseId])
  @@index([courseId])
  @@index([userId])
  @@index([helpfulVotes])
}

// ============================================
// HELPFUL VOTE MODEL
// Tracks which users voted reviews as helpful
// ============================================
model HelpfulVote {
  id        String   @id @default(cuid())
  userId    String
  reviewId  String
  createdAt DateTime @default(now())
  
  user   User         @relation(fields: [userId], references: [id])
  review CourseReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  
  @@unique([userId, reviewId])
  @@index([reviewId])
}

// ============================================
// RESOURCE TYPE ENUM
// Type of study resource
// ============================================
enum ResourceType {
  FLASHCARDS
  NOTES
}

// ============================================
// STUDY RESOURCE MODEL
// Flashcards or notes shared by students
// ============================================
model StudyResource {
  id        String       @id @default(cuid())
  courseId  String
  userId    String
  type      ResourceType
  title     String
  examTag   String?
  upvotes   Int          @default(0)
  usedCount Int          @default(0)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User             @relation(fields: [userId], references: [id])
  flashcards  Flashcard[]
  files       UploadedFile[]
  upvotedBy   ResourceUpvote[]
  savedBy     SavedResource[]
  
  @@index([courseId])
  @@index([userId])
  @@index([type])
  @@index([upvotes])
}

// ============================================
// FLASHCARD MODEL
// Individual flashcards within a set
// ============================================
model Flashcard {
  id         String   @id @default(cuid())
  resourceId String
  front      String   @db.Text
  back       String   @db.Text
  order      Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  resource StudyResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  @@index([resourceId])
}

// ============================================
// UPLOADED FILE MODEL
// Files uploaded as notes (PDF, DOCX, etc.)
// ============================================
model UploadedFile {
  id            String   @id @default(cuid())
  resourceId    String
  fileName      String
  fileUrl       String
  extractedText String?  @db.Text
  fileSize      Int
  mimeType      String
  createdAt     DateTime @default(now())
  
  resource StudyResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  @@index([resourceId])
}

// ============================================
// RESOURCE UPVOTE MODEL
// Tracks who upvoted which resources
// ============================================
model ResourceUpvote {
  id         String   @id @default(cuid())
  userId     String
  resourceId String
  createdAt  DateTime @default(now())
  
  user     User          @relation(fields: [userId], references: [id])
  resource StudyResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  @@unique([userId, resourceId])
  @@index([resourceId])
}

// ============================================
// SAVED COURSE MODEL
// Courses bookmarked by users
// ============================================
model SavedCourse {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  createdAt DateTime @default(now())
  
  user   User   @relation(fields: [userId], references: [id])
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  @@unique([userId, courseId])
  @@index([userId])
}

// ============================================
// SAVED RESOURCE MODEL
// Resources bookmarked by users
// ============================================
model SavedResource {
  id         String   @id @default(cuid())
  userId     String
  resourceId String
  createdAt  DateTime @default(now())
  
  user     User          @relation(fields: [userId], references: [id])
  resource StudyResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  
  @@unique([userId, resourceId])
  @@index([userId])
}